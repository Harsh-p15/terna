<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JanSeva Dashboard</title>
    <style>
        /* --- RESET & LAYOUT --- */
        body { margin: 0; font-family: 'Segoe UI', sans-serif; display: flex; height: 100vh; background-color: #f4f6f8; overflow: hidden; }
        
        /* --- SIDEBAR --- */
        .sidebar { width: 250px; background-color: #2c3e50; color: white; display: flex; flex-direction: column; padding: 20px; flex-shrink: 0; }
        .brand { font-size: 24px; font-weight: bold; margin-bottom: 40px; text-align: center; color: #ecf0f1; }
        .nav-item { padding: 15px; background-color: #34495e; color: white; border-radius: 8px; font-weight: bold; text-align: center; margin-bottom: 10px; cursor: default; }
        
        .logout-btn { margin-top: auto; background-color: #e74c3c; color: white; border: none; padding: 12px; border-radius: 8px; cursor: pointer; font-size: 16px; font-weight: bold; width: 100%; }
        .logout-btn:hover { background-color: #c0392b; }

        /* --- MAIN CONTENT --- */
        .main-content { flex: 1; padding: 30px; overflow-y: auto; display: flex; flex-direction: column; }
        h1 { margin-top: 0; margin-bottom: 20px; color: #333; }

        .dashboard-grid { display: flex; gap: 20px; height: 100%; }

        /* CARDS */
        .card { background: white; border-radius: 12px; padding: 25px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); display: flex; flex-direction: column; }
        .report-section { flex: 2; }
        .history-section { flex: 1; overflow-y: hidden; }

        /* INPUTS */
        input, textarea { width: 100%; padding: 12px; margin-bottom: 15px; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; font-family: inherit; }
        textarea { height: 100px; resize: none; }
        
        /* GPS BOX */
        .gps-box { background: #e8f5e9; color: #2e7d32; padding: 15px; border-radius: 6px; margin-bottom: 15px; font-size: 14px; border: 1px solid #c3e6cb; line-height: 1.5; }
        .map-link { display: inline-block; margin-top: 5px; color: #007bff; text-decoration: none; font-weight: bold; }

        /* BUTTONS */
        .submit-btn { background-color: #3498db; color: white; border: none; padding: 12px; border-radius: 6px; font-size: 16px; cursor: pointer; font-weight: bold; width: 100%; }
        .submit-btn:disabled { background-color: #bdc3c7; cursor: not-allowed; }

        /* HISTORY LIST */
        .history-list { overflow-y: auto; flex: 1; padding-right: 5px; height: 100%; }
        .history-item { display: flex; gap: 12px; border-bottom: 1px solid #eee; padding: 12px 0; align-items: center; }
        .history-item img { width: 50px; height: 50px; border-radius: 6px; object-fit: cover; border: 1px solid #ddd; }
        .badge { font-size: 10px; padding: 2px 8px; border-radius: 10px; font-weight: bold; text-transform: uppercase; }
        .PENDING { background: #fff3cd; color: #856404; }
        .RESOLVED { background: #d4edda; color: #155724; }
    </style>
</head>
<body>

    <div class="sidebar">
        <div class="brand">JanSeva Portal</div>
        <div class="nav-item">üè† Home</div>
        <button onclick="logout()" class="logout-btn">Logout üö™</button>
    </div>

    <div class="main-content">
        <h1>Citizen Dashboard</h1>
        
        <div class="dashboard-grid">
            
            <div class="card report-section">
                <h2 style="margin-top:0;">üì∏ Report an Issue</h2>
                
                <label style="font-weight:bold; display:block; margin-bottom:5px;">Description</label>
                <textarea id="desc" placeholder="Describe the issue..."></textarea>
                
                <label style="font-weight:bold; display:block; margin-bottom:5px;">Upload Photo</label>
                <input type="file" id="fileInput" accept="image/*">
                
                <div id="gps" class="gps-box" style="background:#fff3cd; color:#856404; text-align:center;">
                    üìç Detecting Location...
                </div>
                
                <button type="button" id="btnSubmit" onclick="submitReport()" class="submit-btn" disabled>Submit Report</button>
            </div>

            <div class="card history-section">
                <h2 style="margin-top:0; border-bottom:1px solid #eee; padding-bottom:10px;">üìú Your History</h2>
                <div id="historyList" class="history-list">
                    <p style="text-align:center; color:#999; margin-top:20px;">Loading reports...</p>
                </div>
            </div>

        </div>
    </div>

    <script>
        // 1. SECURITY CHECK (Immediate Kick)
        const token = localStorage.getItem('token');
        if (!token) {
            window.location.href = "/home/login/";
        }

        let lat = null, long = null;

        // 2. GET GPS & ADDRESS
        navigator.geolocation.getCurrentPosition(
            async (p) => {
                lat = p.coords.latitude;
                long = p.coords.longitude;
                const gpsDiv = document.getElementById('gps');

                gpsDiv.style.background = "#d4edda"; 
                gpsDiv.style.color = "#155724";
                gpsDiv.style.textAlign = "left";
                gpsDiv.innerHTML = `‚úÖ <strong>Coordinates Locked:</strong> ${lat.toFixed(5)}, ${long.toFixed(5)}<br>Fetching Address...`;
                document.getElementById('btnSubmit').disabled = false;

                try {
                    const response = await fetch(`https://api.bigdatacloud.net/data/reverse-geocode-client?latitude=${lat}&longitude=${long}&localityLanguage=en`);
                    const data = await response.json();
                    const address = `${data.locality || ''}, ${data.city || ''}, ${data.principalSubdivision || ''}`;
                    const googleMapUrl = `https://www.google.com/maps?q=${lat},${long}`;

                    gpsDiv.innerHTML = `
                        <div style="margin-bottom:5px;">‚úÖ <strong>Location Found:</strong></div>
                        <div style="font-size:13px; color:#555;">${address}</div>
                        <a href="${googleMapUrl}" target="_blank" class="map-link">üó∫Ô∏è View on Google Maps</a>
                    `;
                } catch (error) {
                    console.error("Address Error");
                    gpsDiv.innerHTML += `<br><small style="color:red">Address unavailable</small>`;
                }
            },
            () => {
                const gpsDiv = document.getElementById('gps');
                gpsDiv.innerText = "‚ö†Ô∏è GPS Denied. Please allow access.";
                gpsDiv.style.background = "#f8d7da";
                gpsDiv.style.color = "#721c24";
            }
        );

        // 3. LOAD HISTORY
        async function loadHistory() {
            try {
                const res = await fetch('/home/api/reports/', {
                    headers: { 'Authorization': `Token ${token}` }
                });
                const data = await res.json();
                const list = document.getElementById('historyList');

                if(data.length === 0) {
                    list.innerHTML = "<p style='text-align:center; color:#999; margin-top:20px;'>No reports submitted yet.</p>";
                    return;
                }
                list.innerHTML = ""; 
                data.forEach(r => {
                    let statusClass = r.status === 'RESOLVED' ? 'RESOLVED' : 'PENDING';
                    list.innerHTML += `
                        <div class="history-item">
                            <img src="${r.image_before}" alt="Issue">
                            <div class="history-info">
                                <strong>${r.description.substring(0, 30)}...</strong>
                                <span class="badge ${statusClass}">${r.status}</span>
                                <br><small style="color:#777;">${new Date(r.date_reported).toLocaleDateString()}</small>
                            </div>
                        </div>
                    `;
                });
            } catch (err) { console.error(err); }
        }
        loadHistory(); 

        // 4. SUBMIT REPORT
        async function submitReport() {
            const desc = document.getElementById('desc').value;
            const file = document.getElementById('fileInput').files[0];

            if (!desc || !file) return alert("Please fill description and upload photo!");
            if (!lat) return alert("Waiting for GPS...");

            const btn = document.getElementById('btnSubmit');
            btn.innerText = "Uploading...";
            btn.disabled = true;

            const formData = new FormData();
            formData.append('description', desc);
            formData.append('image_before', file);
            formData.append('latitude', lat);
            formData.append('longitude', long);

            try {
                const res = await fetch('/home/api/reports/', {
                    method: 'POST',
                    headers: { 'Authorization': `Token ${token}` },
                    body: formData
                });

                if (res.ok) {
                    alert("Report Submitted Successfully! üéâ");
                    document.getElementById('desc').value = "";
                    document.getElementById('fileInput').value = "";
                    loadHistory();
                } else {
                    alert("Failed to submit report.");
                }
            } catch (err) {
                console.error(err);
                alert("Error connecting to server.");
            } finally {
                btn.innerText = "Submit Report";
                btn.disabled = false;
            }
        }

        function logout() {
            localStorage.clear();
            window.location.href = "/home/login/";
        }
    </script>
</body>
</html>